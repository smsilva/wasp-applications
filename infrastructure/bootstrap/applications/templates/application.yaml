{{- range $application := .Values.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $application.name }}
  namespace: {{ $.Values.global.environment.namespace }}

  {{- if $application.finalizers }}
  {{- with $application.finalizers }}
  
  finalizers:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.global.finalizers }}

  finalizers:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}

  annotations:
    argocd.argoproj.io/sync-wave: {{ ($application.wave | quote) | default ("100" | quote) }}
spec:
  project: {{ $application.project | default "infra" }}

  {{- if $application.source }}
  {{- with $application.source }}
  
  source:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}

  source:
    repoURL: https://github.com/smsilva/wasp-gitops.git
    targetRevision: HEAD
    path: infrastructure/charts/{{ $application.name }}
  {{- with $.Values.global.environment }}
    helm:
      values: |
        global:
          environment:
          {{- toYaml . | nindent 12 }}
  {{- end }}
  {{- end }}

  {{- if $application.destination }}
  {{- with $application.destination }}

  destination:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.global.destination }}

  destination:
    namespace: {{ ($application.namespace) | default ($.Values.global.destination.namespace) }}
    name: {{ ($application.cluster) | default ($.Values.global.destination.name) }}
  {{- end }}
  {{- end }}

  {{- if $application.syncPolicy }}
  {{- with $application.syncPolicy }}

  syncPolicy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.global.syncPolicy }}

  syncPolicy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}

  ignoreDifferences:
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      jsonPointers:
        - /status

    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jsonPointers:
        - /webhooks/0/namespaceSelector/matchExpressions/2
      jqPathExpressions:
        - '.webhooks[]?.failurePolicy'

    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - '.webhooks[]?.clientConfig.caBundle'
        - '.webhooks[]?.namespaceSelector.matchExpressions'
{{- end }}
