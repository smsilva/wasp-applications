{{- range $application := .Values.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $application.name }}
  namespace: {{ $.Values.global.environment.namespace }}

  {{- if $application.finalizers }}
  {{- with $application.finalizers }}
  
  finalizers:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.finalizers }}

  finalizers:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}

  annotations:
    argocd.argoproj.io/sync-wave: {{ ($application.wave | quote) | default ("100" | quote) }}
spec:
  project: {{ $application.project | default "infra" }}

  {{- if $application.source }}
  {{- with $application.source }}
  
  source:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}

  source:
    {{- toYaml $.Values.source | nindent 4 }}
    path: infrastructure/charts/{{ $application.name }}

  {{- with $.Values.global.environment }}
    helm:
      values: |
        global:
          environment:
          {{- toYaml . | nindent 12 }}
  {{- end }}
  {{- end }}

  {{- if $application.destination }}
  {{- with $application.destination }}

  destination:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.destination }}

  destination:
    namespace: {{ ($application.namespace) | default ($.Values.destination.namespace) }}
    name: {{ ($application.cluster) | default ($.Values.destination.name) }}
  {{- end }}
  {{- end }}

  {{- if $application.syncPolicy }}
  {{- with $application.syncPolicy }}

  syncPolicy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- else }}
  {{- with $.Values.syncPolicy }}

  syncPolicy:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  {{- end }}

  ignoreDifferences:
  {{- toYaml $.Values.ignoreDifferences | nindent 4 }}
{{- end }}
