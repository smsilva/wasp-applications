parameters:
- name: image
  type: string
  default: unset

- name: command
  type: string
  default: 'plan'

steps:
- script: |
    echo "[INFO] STACK_COMMAND.......................: ${STACK_COMMAND}"
    echo "[INFO] STACK_IMAGE.........................: ${STACK_IMAGE}"

    $(Agent.TempDirectory)/terraform-packager/scripts/stackrun "${STACK_IMAGE}" "${STACK_COMMAND}"

    if [[ $? != "0" ]]; then
      echo "##vso[task.logissue type=error]Your Stack failed executing the Terraform command."
      exit 1
    fi

  displayName: 'Terraform ${{ parameters.command }}'
  failOnStderr: true
  condition: succeeded()
  env:
    STACK_INSTANCE_NAME: $(stackInstanceName)
    STACK_COMMAND:       ${{ parameters.command }}
    STACK_IMAGE:         ${{ parameters.image }}
    ARM_ACCESS_KEY:      $(ARM_ACCESS_KEY)
    ARM_CLIENT_SECRET:   $(ARM_CLIENT_SECRET)
