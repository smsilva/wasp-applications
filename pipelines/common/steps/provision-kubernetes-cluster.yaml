parameters:
  - name:    image
    type:    string
    default: silviosilva/azure-kubernetes-cluster:3.9.0-wasp-sbx-eus2-blue

steps:
  - script: |
      env DEBUG=2 stackrun ${{ parameters.image }} apply
    displayName: 'Provision Kubernetes Cluster'
    env:
      ENVIRONMENT_NAME:  ${{ parameters.environment }}
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_ACCESS_KEY:    $(ARM_ACCESS_KEY)

  - script: |
      mkdir -p ${HOME}/.kube

      env DEBUG=0 stackrun ${{ parameters.image }} output -raw kubeconfig > ${HOME}/.kube/config

      chmod 0600 ${HOME}/.kube/config

      kubectl config get-contexts
      kubectl get namespaces
    displayName: 'Provision Kubernetes Cluster Credentials'
    env:
      ENVIRONMENT_NAME:  ${{ parameters.environment }}
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_ACCESS_KEY:    $(ARM_ACCESS_KEY)
